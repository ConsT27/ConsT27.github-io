<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>橄榄阿里云服务 - ConsT27's Blog</title>
    <link href="../../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "\u6a44\u6984\u963f\u91cc\u4e91\u670d\u52a1", url: "#_top", children: [
              {title: "\u76ee\u5f55", url: "#_2" },
              {title: "OSS", url: "#oss" },
              {title: "ECS", url: "#ecs" },
          ]},
        ];

    </script>
    <script src="../../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../../%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F/%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../../%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F/%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F/" class="btn btn-xs btn-link">
        办公系统
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../%E6%A9%84%E6%A6%84AWS%EF%BC%81/%E6%A9%84%E6%A6%84AWS%EF%BC%81/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../%E6%A9%84%E6%A6%84AWS%EF%BC%81/%E6%A9%84%E6%A6%84AWS%EF%BC%81/" class="btn btn-xs btn-link">
        橄榄AWS！
      </a>
    </div>
    
  </div>

    

    <h1 id="_1">橄榄阿里云服务</h1>
<h2 id="_2">目录</h2>
<ul>
<li><a href="#OSS">OSS</a><ul>
<li><a href="#Key遍历爆破">Key遍历/爆破</a></li>
<li><a href="#未授权上传">未授权上传</a></li>
<li><a href="#策略公开可读">策略公开可读</a></li>
<li><a href="#ACL可读写">ACL可读写</a></li>
<li><a href="#AccessKeyIdSecretAccessKey泄露">AccessKeyId，SecretAccessKey泄露</a></li>
</ul>
</li>
<li><a href="#ECS">ECS</a><ul>
<li><a href="#ssrf读取用户数据">ssrf读取用户数据</a></li>
<li><a href="#命令执行">命令执行</a></li>
<li><a href="#创建持久化ram账号">创建持久化ram账号</a></li>
<li><a href="#利用云函数权限维持">利用云函数权限维持</a></li>
<li><a href="#利用后门镜像权限维持">利用后门镜像权限维持</a></li>
</ul>
</li>
</ul>
<p>环境搭建：<a href="https://github.com/HuoCorp/TerraformGoat" title="https://github.com/HuoCorp/TerraformGoat">https://github.com/HuoCorp/TerraformGoat</a></p>
<h2 id="oss">OSS</h2>
<p>OSS即阿里云的对象存储服务</p>
<h3 id="key">Key遍历/爆破</h3>
<p>如果Bucket的ListObjects权限打开了，授权用户给的是匿名账号（列出key值），并且Bucket ACL是公共读或者公共读写（访问资源），那么就可以在URL遍历所有key值，并访问这些资源</p>
<p><img alt="" src="../image/image_tQX_NWyfzj.png" /></p>
<p><img alt="" src="../image/image_ar_gcyw5zX.png" /></p>
<p>就像这样</p>
<p><img alt="" src="../image/image_SW0nwP9LcL.png" /></p>
<p>爆破就是直接目录爆破了，没啥好说的，OSS里key值就可以理解为文件名</p>
<h3 id="_3">未授权上传</h3>
<p>如果存储桶配置为可写，那么就可以进行任意文件上传</p>
<p>oss后台里的Bucket ACL设置为公共读写后就可能遇到这种安全问题</p>
<p><img alt="" src="../image/image_NTltzTTfdP.png" /></p>
<p><img alt="" src="../image/image_rd9QPA4S6R.png" /></p>
<p>可以看到我们向一个存储桶里写入了一个名为test.txt的文件且内容为asd，服务端返回了200</p>
<p><img alt="" src="../image/image__U7x_y1Guf.png" /></p>
<p>再来看看到底上传过去没,访问 bucket-url/text.txt，发现确实是写入了</p>
<p><img alt="" src="../image/image_tqWq_yqwon.png" /></p>
<p>不仅如此，还可以覆盖其他文件</p>
<p>这是原本的object内容</p>
<p><img alt="" src="../image/image_eyaYdNSxN5.png" /></p>
<p>覆盖</p>
<p><img alt="" src="../image/image_ZGeFfhuimq.png" /></p>
<p>发现确实覆盖了</p>
<p><img alt="" src="../image/image_H_fpP7zqh3.png" /></p>
<h3 id="_4">策略公开可读</h3>
<p>即策略可以被任何人读到</p>
<p>oss给匿名帐户开启了GetBucketPolicy</p>
<p><a href="https://help.aliyun.com/document_detail/154887.html" title="GetBucketPolicy (aliyun.com)">GetBucketPolicy (aliyun.com)</a></p>
<p><img alt="" src="../image/image_hwkBjhr236.png" /></p>
<p><img alt="" src="../image/image_-F62Qowhdp.png" /></p>
<p>url?policy</p>
<p><img alt="" src="../image/image_nA0Gs572LH.png" /></p>
<h3 id="acl">ACL可读写</h3>
<p>即Object的ACL可以被看见、可以被任意修改</p>
<p>为匿名帐号打开了GetObjectAcl 和 PutObjectAcl后就会出现这种问题</p>
<p><a href="https://help.aliyun.com/document_detail/31987.html" title="https://help.aliyun.com/document_detail/31987.html">https://help.aliyun.com/document_detail/31987.html</a> GetObjectAcl&#x20;</p>
<p><a href="https://help.aliyun.com/document_detail/31986.html" title="https://help.aliyun.com/document_detail/31986.html">https://help.aliyun.com/document_detail/31986.html</a> PutObjectAcl</p>
<p><img alt="" src="../image/image_0vF_dYdZ0H.png" /></p>
<p>访问 bucket_url/objectname?acl 即可看到对应object的acl</p>
<p><img alt="" src="../image/image_YJS7S1s53X.png" /></p>
<p>然后使用PUT方法，附带x-oss-object-acl 请求头，就能对请求的object的acl进行修改</p>
<p><img alt="" src="../image/image_gQLiQwnqgJ.png" /></p>
<p><img alt="" src="../image/image_JMf3qd0e51.png" /></p>
<p>PUT发包以后，再次查看对应object的acl，变成了public-read</p>
<p><img alt="" src="../image/image_FB7U551a5c.png" /></p>
<h3 id="accesskeyidsecretaccesskey">AccessKeyId，SecretAccessKey泄露</h3>
<p>这俩东西泄露了就能直接接管OSS了。利用工具<a href="https://github.com/mrknow001/aliyun-accesskey-Tools" title="https://github.com/mrknow001/aliyun-accesskey-Tools">https://github.com/mrknow001/aliyun-accesskey-Tools</a></p>
<p>或者使用阿里云提供的cli（aliyun） ，输入 aliyun configure ，把ak输进去就能用这个账号的各个接口API了</p>
<p>一般会在下面这些场景泄露：</p>
<p>源码、网站前端代码、反汇编APP</p>
<p>当然，如果控制台账号密码泄露了，那么就可以直接接管所有该账户上的资源了</p>
<h2 id="ecs">ECS</h2>
<p>ref:<a href="https://zone.huoxian.cn/d/1064-ecs" title="https://zone.huoxian.cn/d/1064-ecs">https://zone.huoxian.cn/d/1064-ecs</a></p>
<h3 id="ssrf">ssrf读取用户数据</h3>
<p>在阿里云ECS里 可以直接访问<a href="http://100.100.100.200/latest/[metadata]" title="http://100.100.100.200/latest/[metadata]">http://100.100.100.200/latest/[metadata]</a> 来查看实例的元数据，如meta-data查看所有元数据根目录，instance-id查看实例id等，更多请见官方文档<a href="https://help.aliyun.com/document_detail/108460.html" title="https://help.aliyun.com/document_detail/108460.html">https://help.aliyun.com/document_detail/108460.html</a></p>
<p><img alt="" src="../image/image_hteRR1E2cz.png" /></p>
<p>如果ECS上存在ssrf漏洞，则可以通过访问这个IP来获取元数据</p>
<p>如果ecs绑定了ram账户，那么就可以通过读取元数据来读取ram账户的ak，从而接管此账户</p>
<pre><code class="language-text">100.100.100.200/latest/meta-data/ram/security-credentials 获取绑定的ram账户名
100.100.100.200/latest/meta-data/ram/security-credentials/ram_username 获取ak信息

</code></pre>
<h3 id="_5">命令执行</h3>
<p>在我们获取ak后，利用aliyun cli 即可快捷的在ecs里执行命令</p>
<pre><code class="language-text">aliyun ecs DescribeInstances 获取所有ecs实例信息
aliyun ecs RunCommand --InstanceId.1 i-2ze2sfmwdrs1z5xxoumk --RegionId cn-beijing --Type RunShellScript --CommandContent &quot;touch /tmp/UzJu&quot; 执行命令

</code></pre>
<h3 id="ram">创建持久化ram账号</h3>
<h3 id="_6">利用云函数权限维持</h3>
<h3 id="_7">利用后门镜像权限维持</h3>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../../%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F/%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../../%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F/%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F/" class="btn btn-xs btn-link">
        办公系统
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../%E6%A9%84%E6%A6%84AWS%EF%BC%81/%E6%A9%84%E6%A6%84AWS%EF%BC%81/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../%E6%A9%84%E6%A6%84AWS%EF%BC%81/%E6%A9%84%E6%A6%84AWS%EF%BC%81/" class="btn btn-xs btn-link">
        橄榄AWS！
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>